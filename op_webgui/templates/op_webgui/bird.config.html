{% extends 'op_webgui/config.html' %}

{% load bootstrap3 %}

{% block device_config %}
# /etc/bird/bird.conf

router id {{ router.routing_id }}; 

# Device status
protocol device {
  scan time 10; # recheck every 10 seconds
}

protocol direct {
  interface "lo*";
}

protocol static {
  route 172.22.150.64/26 reject;
};

# local configuration
######################

log "/var/log/bird/daemon" all;

define OWNAS = 4242420031;
define OWNIP = {{ router.routing_id }};

function is_self_net() {
  return net ~ [172.22.150.64/26+];
}

function is_valid_network() {
 return net ~ [
 172.22.0.0/15{22,28},
 172.20.0.0/16{21,28},
 172.22.0.0/23{23,32},
 172.23.0.0/24{24,32},
 192.175.48.0/24{24,32},
 10.0.0.0/8{12,28},
 172.31.0.0/16{22,28},
 100.64.0.0/10{12,28},
 195.160.168.0/23{23,28},
 91.204.4.0/22{22,28},
 193.43.220.0/23{23,28},
 83.133.178.0/23{23,28},
 87.106.29.254/32{32,32},
 85.25.246.16/28{28,32},
 46.4.248.192/27{27,32},
 94.45.224.0/19{19,28},
 151.217.0.0/16{16,28},
 195.191.196.0/23{23,29},
 80.244.241.224/27{27,32},
 188.40.34.241/32{32,32},
 37.1.89.192/26{26,28},
 87.98.246.19/32{32,32}
 ];
}

function is_anycast_invalid() {
 return net ~ [
 172.20.0.0/24{24,27},
 172.22.0.0/24{24,27},
 172.23.0.0/24{24,27}
 ];
}

protocol kernel {
  scan time 20;
  device routes;
  import none;
  export filter {
    krt_prefsrc = OWNIP;
    accept;
  };
};

template bgp dnpeers {
  local as OWNAS;
  path metric 1;
  import keep filtered;
  import filter {
    if is_valid_network() && !is_self_net() && !is_anycast_invalid() then {
      accept;
    }
    reject;
  };
  export filter {
    if is_valid_network() then {
      accept;
    }
    reject;
  };
  route limit 10000;
};

template bgp ibgp {
  local as OWNAS;
  path metric 1;
  route limit 10000;
  source address OWNIP;
  gateway recursive;
  next hop self;
  import filter {
    if net != 172.22.150.126/32 then {
      accept;
    }
  };
  export filter {
    accept;
  };
};

{% for router in router_list %}
protocol bgp {{ router.hostname }} from ibgp {
  neighbor {{ router.routing_id }} as 4242420031;
};
{% endfor %}
{% for neighbor in router.neighbor_set.all %}
protocol bgp {{ neighbor.aut_num.name }}_{{ neighbor.peer_ip }} from dnpeers {
  neighbor {{ neighbor.peer_ip }} as {{ neighbor.aut_num.asn }};
};
{% endfor %}

{% endblock %}
